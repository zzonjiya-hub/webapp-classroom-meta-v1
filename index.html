<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‹¤ ë©”íƒ€ë²„ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            overflow: hidden;
            background: #2c3e50;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #loginBox {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        #loginBox h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
        }
        
        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .input-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #emojiContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 15px;
        }
        
        .emoji-option {
            font-size: 52px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 4px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.2s;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .emoji-option:hover {
            transform: scale(1.05);
            border-color: #bbb;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .emoji-option.selected {
            border-color: #667eea;
            border-width: 5px;
            background: linear-gradient(135deg, #e7e9fc 0%, #d4d7f7 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        #randomEmojiBtn {
            font-size: 45px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #5568d3 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        #randomEmojiBtn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #4557c2 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        #randomEmojiBtn:active {
            transform: scale(0.95);
        }
        
        #emojiSelector {
            display: none;
        }
        
        #loginBtn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        
        #loginBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #loginBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ê²Œì„ í™”ë©´ */
        #gameScreen {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        #gameContainer {
            position: absolute;
            left: 0;
            top: 0;
            width: 75%;
            height: 100%;
            overflow: auto;
            background: #2c3e50;
        }
        
        #gameCanvas {
            display: block;
            background: #e0e0e0;
            width: 1440px;
            height: 1080px;
        }
        
        /* ì±„íŒ… ì˜ì—­ */
        #chatContainer {
            position: fixed;
            top: 0;
            right: 0;
            width: 25%;
            height: 100vh;
            background: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            border-left: 3px solid #667eea;
            z-index: 100;
        }
        
        #chatHeader {
            background: #2a2a2a;
            padding: 10px 15px;
            border-bottom: 2px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        #chatHeader h3 {
            margin: 0;
            font-size: 16px;
            color: #667eea;
        }
        
        #chatBody {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
        }
        
        #chatMessages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
        }
        
        .chat-message {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        #chatInputContainer {
            display: flex;
            gap: 10px;
        }
        
        #chatInput {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #chatSendBtn {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* êµì‚¬ ì œì–´íŒ */
        #teacherPanel {
            display: none;
            background: #2a2a2a;
            color: white;
            padding: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        #teacherPanel h4 {
            margin: 6px 0 4px 0;
            font-size: 11px;
            color: #ffd700;
            text-align: center;
        }
        
        .teacher-row {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .teacher-btn {
            flex: 1;
            padding: 5px 6px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .teacher-btn:hover {
            background: #5568d3;
        }
        
        .teacher-btn:active {
            transform: scale(0.98);
        }
        }
        
        #teacherPanel h3 {
            margin: 0 0 15px 0;
            color: #ffd700;
            text-align: center;
        }
        
        .teacher-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .teacher-btn:hover {
            background: #5568d3;
        }
        
        .teacher-btn.active {
            background: #ff4444;
        }
        
        /* ê²Œì„ ìƒíƒœ í‘œì‹œ */
        #gameStatus {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            display: none;
            z-index: 100;
        }
        
        /* ì ‘ì†ì ìˆ˜ */
        #userCount {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* ì „ì²´í™”ë©´ ë²„íŠ¼ */
        #fullscreenBtn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #fullscreenBtn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        /* ì¡°ì´ìŠ¤í‹± - ë§ˆì¸í¬ë˜í”„íŠ¸ ìŠ¤íƒ€ì¼ */
        #joystick {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 140px;
            height: 140px;
            z-index: 200;
        }
        
        .joystick-base {
            position: relative;
            width: 140px;
            height: 140px;
            display: grid;
            grid-template-columns: 45px 50px 45px;
            grid-template-rows: 45px 50px 45px;
            gap: 0;
        }
        
        .joystick-button {
            background: linear-gradient(145deg, #4a4a4a, #2a2a2a);
            border: 2px solid #1a1a1a;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            opacity: 0.5;
        }
        
        .joystick-button:active {
            background: linear-gradient(145deg, #3a3a3a, #1a1a1a);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.5);
            transform: translateY(2px);
        }
        
        .joystick-up {
            grid-column: 2;
            grid-row: 1;
            border-radius: 8px 8px 0 0;
        }
        
        .joystick-down {
            grid-column: 2;
            grid-row: 3;
            border-radius: 0 0 8px 8px;
        }
        
        .joystick-left {
            grid-column: 1;
            grid-row: 2;
            border-radius: 8px 0 0 8px;
        }
        
        .joystick-right {
            grid-column: 3;
            grid-row: 2;
            border-radius: 0 8px 8px 0;
        }
        
        /* ì¡°ì´ìŠ¤í‹± ì¤‘ì•™ (ì¥ì‹ìš©) */
        .joystick-center {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(145deg, #3a3a3a, #1a1a1a);
            border: 2px solid #1a1a1a;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen">
        <div id="loginBox">
            <h1>ğŸ« êµì‹¤ ë©”íƒ€ë²„ìŠ¤</h1>
            
            <div class="input-row">
                <div class="input-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
                </div>
                
                <div class="input-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            
            <div class="input-group">
                <label>ìºë¦­í„° ì„ íƒ</label>
                <div id="emojiContainer">
                    <div class="emoji-option" data-index="0">ğŸ˜€</div>
                    <div class="emoji-option" data-index="1">ğŸ˜ƒ</div>
                    <div class="emoji-option" data-index="2">ğŸ˜„</div>
                    <button id="randomEmojiBtn">ğŸ²</button>
                </div>
                <div id="emojiSelector"></div>
            </div>
            
            <button id="loginBtn" disabled>ì…ì¥í•˜ê¸°</button>
        </div>
    </div>
    
    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen">
        <div id="gameContainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <!-- ì¡°ì´ìŠ¤í‹± -->
        <div id="joystick">
            <div class="joystick-base">
                <div class="joystick-button joystick-up" data-direction="up">â–²</div>
                <div class="joystick-center"></div>
                <div class="joystick-button joystick-down" data-direction="down">â–¼</div>
                <div class="joystick-button joystick-left" data-direction="left">â—€</div>
                <div class="joystick-button joystick-right" data-direction="right">â–¶</div>
            </div>
        </div>
        
        <!-- ê²Œì„ ìƒíƒœ -->
        <div id="gameStatus"></div>
        
        <!-- ì±„íŒ… -->
        <div id="chatContainer">
            <div id="chatHeader">
                <h3 id="chatTitle">ğŸ’¬ ì±„íŒ…</h3>
                <div style="display: flex; gap: 5px;">
                    <button id="fullscreenBtn" title="ì „ì²´í™”ë©´">â›¶</button>
                </div>
            </div>
            
            <!-- êµì‚¬ ì œì–´íŒ (ì±„íŒ…ì°½ ë‚´ë¶€) -->
            <div id="teacherPanel">
                <div class="teacher-row">
                    <button class="teacher-btn" id="announceBtn">ğŸ“¢ ê³µì§€í•˜ê¸°</button>
                    <button class="teacher-btn" id="clearChatBtn">ğŸ—‘ï¸ ì±„íŒ… ì§€ìš°ê¸°</button>
                </div>
                <div class="teacher-row">
                    <button class="teacher-btn" id="gatherStudentsBtn">ğŸ‘¥ í•™ìƒ ëª¨ì´ê¸°</button>
                    <button class="teacher-btn" id="kickAllBtn">ğŸšª í•™ìƒ ë‚´ë³´ë‚´ê¸°</button>
                </div>
                <div class="teacher-row">
                    <button class="teacher-btn" id="regenerateObstaclesBtn">ğŸ§± ì¥ì• ë¬¼ ì¬ì„¤ì¹˜</button>
                    <button class="teacher-btn" id="clearObstaclesBtn">ğŸ§¹ ì¥ì• ë¬¼ ì§€ìš°ê¸°</button>
                </div>
                <h4>ğŸ® ë¯¸ë‹ˆê²Œì„</h4>
                <div class="teacher-row">
                    <button class="teacher-btn" id="poopGameBtn">ğŸ’© ë˜¥ í”¼í•˜ê¸°</button>
                    <button class="teacher-btn" id="zombieGameBtn">ğŸ˜± ì¢€ë¹„ ê²Œì„</button>
                </div>
            </div>
            
            <div id="chatBody">
                <div id="chatMessages"></div>
                <div id="chatInputContainer">
                    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="chatSendBtn">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBiEjxmFOa2aq86KgARZo80SI_CzQwDxDo",
            authDomain: "classroom-meta.firebaseapp.com",
            databaseURL: "https://classroom-meta-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "classroom-meta",
            storageBucket: "classroom-meta.firebasestorage.app",
            messagingSenderId: "473991431124",
            appId: "1:473991431124:web:dd12f53390bfb57786cc41"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ kickAll ë°ì´í„° ë¬´ì¡°ê±´ ì •ë¦¬ (ì´ì „ ì„¸ì…˜ì˜ ì”ì—¬ ë°ì´í„° ì œê±°)
        database.ref('kickAll').once('value', (snapshot) => {
            if (snapshot.exists()) {
                database.ref('kickAll').remove();
                console.log('ì´ì „ kickAll ë°ì´í„° ì •ë¦¬ë¨');
            }
        });
        
        // ì´ëª¨ì§€ ëª©ë¡
        const emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','â˜ºï¸','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¤©','ğŸ¥³','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬'];
        
        // ë¹„ë°€ë²ˆí˜¸
        const STUDENT_PASSWORD = '3300';
        const TEACHER_PASSWORD = 'zzonji';
        
        // ì „ì—­ ë³€ìˆ˜
        let myUserId = null;
        let myName = '';
        let myEmoji = '';
        let isTeacher = false;
        let users = {};
        let currentGame = null; // 'poop' or 'zombie'
        let obstacles = []; // ì¥ì• ë¬¼ ë°°ì—´
        
        // ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        const sounds = {
            // ë˜¥ í”¼í•˜ê¸° ê²Œì„ ì‹œì‘
            poopStart: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.3);
            },
            
            // ë˜¥ ë§ìŒ
            poopHit: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.2);
            },
            
            // ìš°ìŠ¹
            win: () => {
                [0, 0.1, 0.2].forEach((time, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    const freq = [523, 659, 784][i]; // C, E, G
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime + time);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + time + 0.3);
                    
                    osc.start(audioCtx.currentTime + time);
                    osc.stop(audioCtx.currentTime + time + 0.3);
                });
            },
            
            // ì¢€ë¹„ ê²Œì„ ì‹œì‘
            zombieStart: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.5);
            },
            
            // ì¢€ë¹„ ê°ì—¼
            zombieInfect: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.15);
            },
            
            // ê³µì§€ íš¨ê³¼ìŒ
            announce: () => {
                // ì¢…ì†Œë¦¬ì²˜ëŸ¼ "ë”©ë™" íš¨ê³¼
                [0, 0.15].forEach((time, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    const freq = i === 0 ? 800 : 600; // ë†’ì€ìŒ â†’ ë‚®ì€ìŒ
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime + time);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + time + 0.4);
                    
                    osc.start(audioCtx.currentTime + time);
                    osc.stop(audioCtx.currentTime + time + 0.4);
                });
            },
            
            // ë°°ê²½ìŒ (ê²Œì„ ì¤‘)
            ambience: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(220, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                
                osc.start(audioCtx.currentTime);
                return osc; // ë©ˆì¶œ ìˆ˜ ìˆë„ë¡ ë°˜í™˜
            }
        };
        
        // ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜
        function playSound(soundName) {
            try {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                sounds[soundName]();
            } catch (e) {
                console.log('Sound error:', e);
            }
        }
        
        // Canvas ì„¤ì • (ê³ ì • í¬ê¸°)
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 1440;
        canvas.height = 1080;
        
        // í”Œë ˆì´ì–´ ì´ˆê¸° ìœ„ì¹˜ (ì¤‘ì•™)
        let myPosition = {
            x: canvas.width / 2,
            y: canvas.height / 2
        };
        
        const MOVE_SPEED = 5;
        const keys = {};
        
        // í‚¤ë³´ë“œ ì…ë ¥
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // ë¡œê·¸ì¸ í™”ë©´ ì„¤ì • - DOM ë¡œë“œ í›„ ì‹¤í–‰ ë³´ì¥
        console.log('ë¡œê·¸ì¸ ì„¤ì • ì‹œì‘');
        const nameInput = document.getElementById('nameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const emojiOptions = document.querySelectorAll('.emoji-option');
        const randomEmojiBtn = document.getElementById('randomEmojiBtn');
        
        console.log('nameInput:', nameInput);
        console.log('passwordInput:', passwordInput);
        console.log('loginBtn:', loginBtn);
        console.log('emojiOptions:', emojiOptions);
        console.log('randomEmojiBtn:', randomEmojiBtn);
        
        let currentEmojis = [];
        
        // checkLoginReady í•¨ìˆ˜ë¥¼ ë¨¼ì € ì •ì˜
        function checkLoginReady() {
            const ready = myName !== '' && myEmoji !== '' && passwordInput.value !== '';
            loginBtn.disabled = !ready;
            console.log('checkLoginReady:', {myName, myEmoji, password: passwordInput.value, ready});
        }
        
        // 3ê°œì˜ ëœë¤ ì´ëª¨ì§€ ì„ íƒ í•¨ìˆ˜
        function selectRandomEmojis() {
            console.log('selectRandomEmojis í˜¸ì¶œ');
            const shuffled = [...emojis].sort(() => Math.random() - 0.5);
            currentEmojis = shuffled.slice(0, 3);
            console.log('ì„ íƒëœ ì´ëª¨ì§€:', currentEmojis);
            
            emojiOptions.forEach((option, index) => {
                option.textContent = currentEmojis[index];
                option.classList.remove('selected');
            });
            
            // ì²« ë²ˆì§¸ ìºë¦­í„°ë¥¼ ìë™ ì„ íƒ
            if (emojiOptions.length > 0) {
                emojiOptions[0].classList.add('selected');
                myEmoji = currentEmojis[0];
                console.log('ì²« ë²ˆì§¸ ìºë¦­í„° ìë™ ì„ íƒ:', myEmoji);
            }
            
            checkLoginReady();
        }
        
        // ì´ˆê¸° 3ê°œ ëœë¤ ì´ëª¨ì§€ í‘œì‹œ ë° ì²« ë²ˆì§¸ ìë™ ì„ íƒ
        console.log('ì´ˆê¸° ì´ëª¨ì§€ ì„¤ì • ì‹œì‘');
        selectRandomEmojis();
        
        // ì´ëª¨ì§€ ì˜µì…˜ í´ë¦­ ì´ë²¤íŠ¸
        emojiOptions.forEach((option) => {
            console.log('ì´ëª¨ì§€ ì˜µì…˜ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€:', option);
            option.addEventListener('click', () => {
                console.log('ì´ëª¨ì§€ í´ë¦­ë¨:', option.textContent);
                // ëª¨ë“  ì„ íƒ í•´ì œ
                emojiOptions.forEach(opt => opt.classList.remove('selected'));
                
                // í´ë¦­í•œ ê²ƒ ì„ íƒ
                option.classList.add('selected');
                myEmoji = option.textContent;
                console.log('ì„ íƒëœ ì´ëª¨ì§€:', myEmoji);
                checkLoginReady();
            });
        });
        
        // ëœë¤ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
        randomEmojiBtn.addEventListener('click', (e) => {
            console.log('ì£¼ì‚¬ìœ„ ë²„íŠ¼ í´ë¦­ë¨');
            e.preventDefault();
            selectRandomEmojis();
        });
        
        nameInput.addEventListener('input', (e) => {
            myName = e.target.value.trim();
            console.log('ì´ë¦„ ì…ë ¥:', myName);
            checkLoginReady();
        });
        
        passwordInput.addEventListener('input', () => {
            console.log('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:', passwordInput.value);
            checkLoginReady();
        });
        
        // ë¡œê·¸ì¸
        loginBtn.addEventListener('click', () => {
            console.log('ì…ì¥í•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨');
            const password = passwordInput.value;
            
            if (password !== STUDENT_PASSWORD && password !== TEACHER_PASSWORD) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                return;
            }
            
            isTeacher = (password === TEACHER_PASSWORD);
            
            // Firebaseì— ì‚¬ìš©ì ë“±ë¡
            myUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const userRef = database.ref('users/' + myUserId);
            userRef.set({
                name: myName,
                emoji: myEmoji,
                isTeacher: isTeacher,
                x: myPosition.x,
                y: myPosition.y,
                timestamp: Date.now()
            });
            
            // ì—°ê²° ëŠê¹€ ì‹œ ìë™ ì‚­ì œ
            userRef.onDisconnect().remove();
            
            // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¸°ê³  ê²Œì„ í™”ë©´ í‘œì‹œ
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            // ì±„íŒ… ì œëª© ë³€ê²½
            if (isTeacher) {
                document.getElementById('chatTitle').textContent = 'ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ë²„ì „';
                document.getElementById('teacherPanel').style.display = 'block';
            } else {
                document.getElementById('chatTitle').textContent = 'ğŸ‘¦ í•™ìƒ ë²„ì „';
            }
            
            // ê²Œì„ ì‹œì‘
            startGame();
        });
        
        // ê²Œì„ ì‹œì‘
        function startGame() {
            // ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™”
            database.ref('users').on('value', (snapshot) => {
                users = snapshot.val() || {};
                
                // ë‚´ ìœ„ì¹˜ê°€ ì„œë²„ì—ì„œ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ë¡œì»¬ë„ ì—…ë°ì´íŠ¸ (í•™ìƒ ëª¨ì´ê¸° ë“±)
                if (users[myUserId]) {
                    myPosition.x = users[myUserId].x;
                    myPosition.y = users[myUserId].y;
                }
                
                updateUserCount();
            });
            
            // ì±„íŒ… ë©”ì‹œì§€ ì‹¤ì‹œê°„ ë™ê¸°í™”
            database.ref('chat').limitToLast(20).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                addChatMessage(msg);
            });
            
            // ì±„íŒ… ì „ì²´ ì‚­ì œ ê°ì§€
            database.ref('chat').on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // ì±„íŒ…ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆì„ ë•Œ
                    document.getElementById('chatMessages').innerHTML = '';
                }
            });
            
            // ê²Œì„ ìƒíƒœ ë™ê¸°í™”
            database.ref('game').on('value', (snapshot) => {
                const gameData = snapshot.val();
                if (gameData) {
                    currentGame = gameData.type;
                    if (gameData.type === 'poop') {
                        startPoopGame(gameData);
                    } else if (gameData.type === 'zombie') {
                        startZombieGame(gameData);
                    }
                } else {
                    currentGame = null;
                    poops = [];
                    zombies = {};
                }
            });
            
            // ì¥ì• ë¬¼ ë™ê¸°í™”
            let obstaclesInitialized = false;
            database.ref('obstacles').on('value', (snapshot) => {
                const obstaclesData = snapshot.val();
                if (obstaclesData) {
                    obstacles = obstaclesData;
                    obstaclesInitialized = true;
                } else {
                    obstacles = [];
                    // êµì‚¬ë§Œ ì¥ì• ë¬¼ ì´ˆê¸° ìƒì„± (ìµœì´ˆ 1íšŒë§Œ)
                    if (isTeacher && !obstaclesInitialized) {
                        generateObstacles();
                        obstaclesInitialized = true;
                    }
                }
            });
            
            // ê²Œì„ ë£¨í”„ ì‹œì‘
            gameLoop();
            
            // ì¡°ì´ìŠ¤í‹± ì´ë²¤íŠ¸
            const joystickButtons = document.querySelectorAll('.joystick-button');
            joystickButtons.forEach(button => {
                const direction = button.getAttribute('data-direction');
                
                // í„°ì¹˜ ì´ë²¤íŠ¸
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    keys[getKeyForDirection(direction)] = true;
                });
                
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    keys[getKeyForDirection(direction)] = false;
                });
                
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (PCì—ì„œë„ í´ë¦­ ê°€ëŠ¥)
                button.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    keys[getKeyForDirection(direction)] = true;
                });
                
                button.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    keys[getKeyForDirection(direction)] = false;
                });
                
                button.addEventListener('mouseleave', (e) => {
                    keys[getKeyForDirection(direction)] = false;
                });
            });
            
            function getKeyForDirection(direction) {
                switch(direction) {
                    case 'up': return 'ArrowUp';
                    case 'down': return 'ArrowDown';
                    case 'left': return 'ArrowLeft';
                    case 'right': return 'ArrowRight';
                    default: return '';
                }
            }
            
            // ì „ì²´í™”ë©´ ë²„íŠ¼
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        alert('ì „ì²´í™”ë©´ ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
            
            // ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ ì„¤ì •
            setTimeout(() => {
                updateCamera();
            }, 100);
            
            // í•™ìƒ ë‚´ë³´ë‚´ê¸° ì‹ í˜¸ ê°ì§€ (ë¡œê·¸ì¸ í›„ì—ë§Œ ì‘ë™)
            if (!isTeacher) {
                let lastKickTime = 0;
                const kickListener = database.ref('kickAll').on('value', (snapshot) => {
                    const kickTime = snapshot.val();
                    if (kickTime && kickTime > lastKickTime) {
                        lastKickTime = kickTime;
                        
                        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                        database.ref('kickAll').off('value', kickListener);
                        
                        // ë‚´ ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ
                        database.ref('users/' + myUserId).remove();
                        
                        // í‚¤ ì…ë ¥ ì´ˆê¸°í™”
                        Object.keys(keys).forEach(key => {
                            keys[key] = false;
                        });
                        
                        // alert í›„ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
                        alert('ì„ ìƒë‹˜ì— ì˜í•´ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    }
                });
            }
        }
        
        // ì‚¬ìš©ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateUserCount() {
            const count = Object.keys(users).length;
            const chatTitle = document.getElementById('chatTitle');
            if (isTeacher) {
                chatTitle.textContent = `ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ë²„ì „ (${count}ëª…)`;
            } else {
                chatTitle.textContent = `ğŸ‘¦ í•™ìƒ ë²„ì „ (${count}ëª…)`;
            }
        }
        
        // ì¹´ë©”ë¼ íŒ”ë¡œìš° ê¸°ëŠ¥
        function updateCamera() {
            const gameContainer = document.getElementById('gameContainer');
            const containerWidth = gameContainer.clientWidth;
            const containerHeight = gameContainer.clientHeight;
            
            // í™”ë©´ì´ êµì‹¤ë³´ë‹¤ ì‘ì„ ë•Œë§Œ ìŠ¤í¬ë¡¤
            if (containerWidth < canvas.width || containerHeight < canvas.height) {
                // í”Œë ˆì´ì–´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ìœ ì§€ (ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤)
                const targetScrollX = myPosition.x - containerWidth / 2;
                const targetScrollY = myPosition.y - containerHeight / 2;
                
                // ìŠ¤í¬ë¡¤ ë²”ìœ„ ì œí•œ
                const maxScrollX = canvas.width - containerWidth;
                const maxScrollY = canvas.height - containerHeight;
                
                gameContainer.scrollLeft = Math.max(0, Math.min(maxScrollX, targetScrollX));
                gameContainer.scrollTop = Math.max(0, Math.min(maxScrollY, targetScrollY));
            }
        }
        
        // ì¥ì• ë¬¼ ìƒì„± í•¨ìˆ˜
        function generateObstacles() {
            const WALL_THICKNESS = 40;
            const TILE_SIZE = 40;
            const OBSTACLE_SIZE = 40;
            const CLUSTER_COUNT = 10; // 10ê°œì˜ ë¬¶ìŒ
            const newObstacles = [];
            
            // 3ê°œì”© ë¬¶ìŒ íŒ¨í„´ (ì§ì„  ë˜ëŠ” ã„±ì ã„´ì)
            const patterns = [
                // ê°€ë¡œ ì§ì„ 
                [{x:0, y:0}, {x:1, y:0}, {x:2, y:0}],
                // ì„¸ë¡œ ì§ì„ 
                [{x:0, y:0}, {x:0, y:1}, {x:0, y:2}],
                // ã„±ì (ìš°í•˜)
                [{x:0, y:0}, {x:1, y:0}, {x:1, y:1}],
                // ã„±ì (ì¢Œí•˜)
                [{x:1, y:0}, {x:0, y:0}, {x:0, y:1}],
                // ã„´ì (ìš°ìƒ)
                [{x:0, y:1}, {x:0, y:0}, {x:1, y:0}],
                // ã„´ì (ì¢Œìƒ)
                [{x:1, y:1}, {x:1, y:0}, {x:0, y:0}]
            ];
            
            for (let i = 0; i < CLUSTER_COUNT; i++) {
                let attempts = 0;
                let validCluster = false;
                let clusterObstacles = [];
                
                while (!validCluster && attempts < 100) {
                    // ëœë¤ íŒ¨í„´ ì„ íƒ
                    const pattern = patterns[Math.floor(Math.random() * patterns.length)];
                    
                    // ëœë¤ ì‹œì‘ ìœ„ì¹˜
                    const gridX = Math.floor(Math.random() * Math.floor((canvas.width - WALL_THICKNESS * 2 - TILE_SIZE * 3) / TILE_SIZE));
                    const gridY = Math.floor(Math.random() * Math.floor((canvas.height - WALL_THICKNESS * 2 - TILE_SIZE * 3) / TILE_SIZE));
                    
                    const startX = WALL_THICKNESS + gridX * TILE_SIZE;
                    const startY = WALL_THICKNESS + gridY * TILE_SIZE;
                    
                    // íŒ¨í„´ëŒ€ë¡œ 3ê°œ ë°°ì¹˜
                    clusterObstacles = pattern.map(offset => ({
                        x: startX + offset.x * TILE_SIZE,
                        y: startY + offset.y * TILE_SIZE,
                        size: OBSTACLE_SIZE
                    }));
                    
                    // í™”ë©´ ë²”ìœ„ ì²´í¬
                    validCluster = true;
                    for (const obs of clusterObstacles) {
                        if (obs.x < WALL_THICKNESS || obs.y < WALL_THICKNESS ||
                            obs.x + OBSTACLE_SIZE > canvas.width - WALL_THICKNESS ||
                            obs.y + OBSTACLE_SIZE > canvas.height - WALL_THICKNESS) {
                            validCluster = false;
                            break;
                        }
                    }
                    
                    // ê¸°ì¡´ ì¥ì• ë¬¼ê³¼ ê²¹ì¹˜ëŠ”ì§€ ì²´í¬
                    if (validCluster) {
                        for (const newObs of clusterObstacles) {
                            for (const existingObs of newObstacles) {
                                if (newObs.x === existingObs.x && newObs.y === existingObs.y) {
                                    validCluster = false;
                                    break;
                                }
                            }
                            if (!validCluster) break;
                        }
                    }
                    
                    // ìºë¦­í„°ì™€ ê²¹ì¹˜ëŠ”ì§€ ì²´í¬
                    if (validCluster) {
                        for (const obs of clusterObstacles) {
                            for (let userId in users) {
                                const user = users[userId];
                                if (user && Math.abs(user.x - (obs.x + OBSTACLE_SIZE/2)) < OBSTACLE_SIZE * 2 && 
                                    Math.abs(user.y - (obs.y + OBSTACLE_SIZE/2)) < OBSTACLE_SIZE * 2) {
                                    validCluster = false;
                                    break;
                                }
                            }
                            if (!validCluster) break;
                        }
                    }
                    
                    attempts++;
                }
                
                if (validCluster) {
                    newObstacles.push(...clusterObstacles);
                }
            }
            
            obstacles = newObstacles;
            database.ref('obstacles').set(newObstacles);
        }
        
        // ì¥ì• ë¬¼ ì¶©ëŒ ì²´í¬ í•¨ìˆ˜
        function checkObstacleCollision(x, y, size = 40) {
            for (let i = 0; i < obstacles.length; i++) {
                const obs = obstacles[i];
                // AABB ì¶©ëŒ ì²´í¬
                if (x + size/2 > obs.x && 
                    x - size/2 < obs.x + obs.size &&
                    y + size/2 > obs.y && 
                    y - size/2 < obs.y + obs.size) {
                    return true;
                }
            }
            return false;
        }
        
        // ê²Œì„ ë£¨í”„
        function gameLoop() {
            // ë˜¥ì— ë§ì€ í•™ìƒì€ ì›€ì§ì¼ ìˆ˜ ì—†ìŒ
            const canMove = !eliminatedUsers.has(myUserId);
            
            // ì¢€ë¹„ëŠ” ì†ë„ 2ë°°
            const moveSpeed = (currentGame === 'zombie' && zombies[myUserId]) ? MOVE_SPEED * 2 : MOVE_SPEED;
            
            // ì´ë™ ì²˜ë¦¬
            let moved = false;
            const oldX = myPosition.x;
            const oldY = myPosition.y;
            
            if (canMove) {
                if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                    myPosition.x -= moveSpeed;
                    moved = true;
                }
                if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                    myPosition.x += moveSpeed;
                    moved = true;
                }
                if (keys['ArrowUp'] || keys['w'] || keys['W']) {
                    myPosition.y -= moveSpeed;
                    moved = true;
                }
                if (keys['ArrowDown'] || keys['s'] || keys['S']) {
                    myPosition.y += moveSpeed;
                    moved = true;
                }
            }
            
            // ë²½ ì¶©ëŒ ì²˜ë¦¬
            const WALL_THICKNESS = 40;
            myPosition.x = Math.max(WALL_THICKNESS + 20, Math.min(canvas.width - WALL_THICKNESS - 20, myPosition.x));
            myPosition.y = Math.max(WALL_THICKNESS + 20, Math.min(canvas.height - WALL_THICKNESS - 20, myPosition.y));
            
            // ì¥ì• ë¬¼ ì¶©ëŒ ì²˜ë¦¬
            if (moved && checkObstacleCollision(myPosition.x, myPosition.y)) {
                // ì¶©ëŒ ì‹œ ì´ì „ ìœ„ì¹˜ë¡œ ë˜ëŒë¦¬ê¸°
                myPosition.x = oldX;
                myPosition.y = oldY;
                moved = false;
            }
            
            // ìœ„ì¹˜ê°€ ë³€ê²½ë˜ë©´ Firebase ì—…ë°ì´íŠ¸
            if (moved && (oldX !== myPosition.x || oldY !== myPosition.y)) {
                database.ref('users/' + myUserId).update({
                    x: myPosition.x,
                    y: myPosition.y
                });
                
                // ì¹´ë©”ë¼ íŒ”ë¡œìš° - í”Œë ˆì´ì–´ê°€ í™”ë©´ ê°€ì¥ìë¦¬ì— ê°€ë©´ ìŠ¤í¬ë¡¤
                updateCamera();
            }
            
            // í™”ë©´ ê·¸ë¦¬ê¸°
            drawGame();
            
            // ê²Œì„ ì—…ë°ì´íŠ¸
            if (currentGame === 'poop') {
                updatePoopGame();
            } else if (currentGame === 'zombie') {
                updateZombieGame();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // êµì‹¤ ê·¸ë¦¬ê¸°
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ë°”ë‹¥ (ì²´ìŠ¤íŒ íŒ¨í„´)
            const tileSize = 40;
            const lightGray = '#e8e8e8';
            const darkGray = '#d0d0d0';
            
            for (let y = 0; y < canvas.height; y += tileSize) {
                for (let x = 0; x < canvas.width; x += tileSize) {
                    const isLight = (Math.floor(x / tileSize) + Math.floor(y / tileSize)) % 2 === 0;
                    ctx.fillStyle = isLight ? lightGray : darkGray;
                    ctx.fillRect(x, y, tileSize, tileSize);
                }
            }
            
            // ë²½ (ëª¨ë‘ ê°ˆìƒ‰ìœ¼ë¡œ í†µì¼)
            const WALL_THICKNESS = 40;
            ctx.fillStyle = '#8B4513';
            
            // ìœ„ìª½ ë²½
            ctx.fillRect(0, 0, canvas.width, WALL_THICKNESS);
            
            // ì•„ë˜ìª½ ë²½
            ctx.fillRect(0, canvas.height - WALL_THICKNESS, canvas.width, WALL_THICKNESS);
            
            // ì™¼ìª½ ë²½
            ctx.fillRect(0, 0, WALL_THICKNESS, canvas.height);
            
            // ì˜¤ë¥¸ìª½ ë²½
            ctx.fillRect(canvas.width - WALL_THICKNESS, 0, WALL_THICKNESS, canvas.height);
            
            // ì¥ì• ë¬¼ ê·¸ë¦¬ê¸° (íƒ€ì¼ 1ì¹¸ì— ì •í™•íˆ ë§ì¶¤)
            obstacles.forEach(obs => {
                ctx.font = `${obs.size * 0.9}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ§±', obs.x + obs.size / 2, obs.y + obs.size / 2);
            });
            
            // ëª¨ë“  ì‚¬ìš©ì ê·¸ë¦¬ê¸°
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                if (!user) return;
                
                let emoji = user.emoji;
                
                // ë˜¥ í”¼í•˜ê¸° ê²Œì„ ì¤‘ íƒˆë½ìëŠ” ë˜¥ìœ¼ë¡œ ë³€ê²½
                if (currentGame === 'poop' && eliminatedUsers.has(userId)) {
                    emoji = 'ğŸ’©';
                }
                
                // ì¢€ë¹„ ê²Œì„ ì¤‘ ì¢€ë¹„
                if (currentGame === 'zombie' && zombies[userId]) {
                    emoji = 'ğŸ˜±';
                }
                
                // ì´ëª¨ì§€ ê·¸ë¦¬ê¸° (ì–¼êµ´ í¬ê¸°: 40px)
                const faceSize = 40;
                ctx.font = `${faceSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, user.x, user.y);
                
                // ì´ë¦„í‘œ ê·¸ë¦¬ê¸° (ê°€ë¡œ 80px, ì„¸ë¡œ 40px - 2:1 ë¹„ìœ¨)
                const nameBoxWidth = faceSize * 2;
                const nameBoxHeight = faceSize;
                const nameBoxY = user.y + faceSize / 2; // ì–¼êµ´ ë°”ë¡œ ë°‘
                
                // ë°˜íˆ¬ëª… ê²€ì • ì§ì‚¬ê°í˜• ë°°ê²½
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(
                    user.x - nameBoxWidth / 2,
                    nameBoxY,
                    nameBoxWidth,
                    nameBoxHeight
                );
                
                // í°ìƒ‰ ì´ë¦„ í…ìŠ¤íŠ¸
                ctx.font = '14px Malgun Gothic';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(user.name, user.x, nameBoxY + nameBoxHeight / 2);
                
                // êµì‚¬ í‘œì‹œ (ì´ë¦„í‘œ ìœ„)
                if (user.isTeacher) {
                    ctx.font = '20px Arial';
                    ctx.fillText('ğŸ‘‘', user.x, user.y - faceSize / 2 - 10);
                }
                
                // ì¢€ë¹„ íš¨ê³¼
                if (currentGame === 'zombie' && zombies[userId]) {
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(user.x, user.y, 30, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
            
            // ë˜¥ ê·¸ë¦¬ê¸°
            if (currentGame === 'poop') {
                poops.forEach(poop => {
                    ctx.font = '30px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ğŸ’©', poop.x, poop.y);
                });
            }
        }
        
        // ì°½ë¬¸ ê·¸ë¦¬ê¸°
        
        // ì±„íŒ… ê¸°ëŠ¥
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        
        function sendChat() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // ê²Œì„ ì¤‘ì—ëŠ” í•™ìƒ ì±„íŒ… ë¶ˆê°€
            if (currentGame && !isTeacher) {
                chatInput.value = '';
                return;
            }
            
            if (isAnnounceMode) {
                // ê³µì§€ ëª¨ë“œ
                database.ref('chat').push({
                    userId: 'system',
                    name: 'ğŸ“¢ ê³µì§€',
                    emoji: 'ğŸ“¢',
                    message: message,
                    timestamp: Date.now()
                });
                
                // ê³µì§€ íš¨ê³¼ìŒ
                playSound('announce');
                
                // ê³µì§€ ëª¨ë“œ í•´ì œ
                isAnnounceMode = false;
                chatInput.style.background = '';
                chatInput.style.borderColor = '';
                chatInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                document.getElementById('announceBtn').style.background = '';
            } else {
                // ì¼ë°˜ ì±„íŒ…
                database.ref('chat').push({
                    userId: myUserId,
                    name: myName,
                    emoji: myEmoji,
                    message: message,
                    timestamp: Date.now()
                });
            }
            
            chatInput.value = '';
        }
        
        chatSendBtn.addEventListener('click', sendChat);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });
        
        function addChatMessage(msg) {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message';
            msgDiv.textContent = `${msg.emoji} ${msg.name}: ${msg.message}`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // êµì‚¬ ê¸°ëŠ¥
        let isAnnounceMode = false;
        
        document.getElementById('announceBtn').addEventListener('click', () => {
            isAnnounceMode = !isAnnounceMode;
            const chatInput = document.getElementById('chatInput');
            const announceBtn = document.getElementById('announceBtn');
            
            if (isAnnounceMode) {
                chatInput.style.background = '#fff3cd';
                chatInput.style.borderColor = '#ffc107';
                chatInput.placeholder = 'ê³µì§€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                announceBtn.style.background = '#ffc107';
            } else {
                chatInput.style.background = '';
                chatInput.style.borderColor = '';
                chatInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                announceBtn.style.background = '';
            }
        });
        
        // ì±„íŒ… ë‚´ìš© ì§€ìš°ê¸°
        document.getElementById('clearChatBtn').addEventListener('click', () => {
            database.ref('chat').remove();
            document.getElementById('chatMessages').innerHTML = '';
        });
        
        // ëª¨ë“  í•™ìƒ ëª¨ì´ê¸°
        document.getElementById('gatherStudentsBtn').addEventListener('click', () => {
            const teacherUser = users[myUserId];
            if (teacherUser) {
                Object.keys(users).forEach(userId => {
                    if (userId !== myUserId) {
                        database.ref('users/' + userId).update({
                            x: teacherUser.x,
                            y: teacherUser.y
                        });
                    }
                });
            }
        });
        
        // ëª¨ë“  í•™ìƒ ë‚´ë³´ë‚´ê¸°
        document.getElementById('kickAllBtn').addEventListener('click', () => {
            const kickTimestamp = Date.now();
            database.ref('kickAll').set(kickTimestamp);
            
            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì œê±° (í•™ìƒë“¤ì´ í‡´ì¥í•œ í›„)
            setTimeout(() => {
                database.ref('kickAll').remove();
            }, 3000);
        });
        
        // ì¥ì• ë¬¼ ì¬ì„¤ì¹˜
        document.getElementById('regenerateObstaclesBtn').addEventListener('click', () => {
            generateObstacles();
        });
        
        // ì¥ì• ë¬¼ ì§€ìš°ê¸°
        document.getElementById('clearObstaclesBtn').addEventListener('click', () => {
            obstacles = [];
            database.ref('obstacles').remove();
        });
        
        // ë˜¥ í”¼í•˜ê¸° ê²Œì„
        let poops = [];
        let eliminatedUsers = new Set();
        let poopInterval = null;
        let poopSpawnInterval = 500; // ì´ˆê¸° ìƒì„± ê°„ê²©
        let poopGameStartTime = 0;
        let winnerAnnounced = false;
        
        document.getElementById('poopGameBtn').addEventListener('click', function() {
            if (currentGame === 'poop') {
                // ê²Œì„ ì¤‘ë‹¨
                database.ref('game').remove();
                this.textContent = 'ğŸ’© ë˜¥ í”¼í•˜ê¸°';
                this.classList.remove('active');
                
                // ì¤‘ë‹¨ ê³µì§€
                database.ref('chat').push({
                    userId: 'system',
                    name: 'ğŸ“¢ ê³µì§€',
                    emoji: 'ğŸ“¢',
                    message: 'ğŸ’© ë˜¥ í”¼í•˜ê¸° ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                    timestamp: Date.now()
                });
                playSound('announce');
                
                // ìƒíƒœ ì´ˆê¸°í™”
                if (poopInterval) {
                    clearInterval(poopInterval);
                    poopInterval = null;
                }
                poops = [];
                eliminatedUsers.clear();
                poopSpawnInterval = 500;
                winnerAnnounced = false;
            } else {
                // ê²Œì„ ì‹œì‘
                poopGameStartTime = Date.now();
                winnerAnnounced = false;
                
                database.ref('game').set({
                    type: 'poop',
                    startTime: poopGameStartTime
                });
                this.textContent = 'ğŸ’© ê²Œì„ ì¤‘ë‹¨';
                this.classList.add('active');
                showGameStatus('ğŸ’© ë˜¥ í”¼í•˜ê¸° ê²Œì„ ì‹œì‘!', 2000);
                playSound('poopStart');
                
                // ê³µì§€
                database.ref('chat').push({
                    userId: 'system',
                    name: 'ğŸ“¢ ê³µì§€',
                    emoji: 'ğŸ“¢',
                    message: 'ğŸ’© ë˜¥ í”¼í•˜ê¸° ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!',
                    timestamp: Date.now()
                });
                playSound('announce');
            }
        });
        
        function startPoopGame(gameData) {
            poops = [];
            eliminatedUsers.clear();
            poopGameStartTime = gameData.startTime;
            poopSpawnInterval = 500;
            winnerAnnounced = false;
            
            if (!poopInterval) {
                poopInterval = setInterval(() => {
                    if (currentGame !== 'poop') {
                        clearInterval(poopInterval);
                        poopInterval = null;
                        poops = [];
                        eliminatedUsers.clear();
                        return;
                    }
                    
                    const elapsed = Date.now() - poopGameStartTime;
                    
                    // 10ì´ˆ í›„: 2ë°° ì†ë„ (500ms -> 250ms)
                    if (elapsed >= 10000 && elapsed < 20000 && poopSpawnInterval === 500) {
                        clearInterval(poopInterval);
                        poopSpawnInterval = 250;
                        poopInterval = setInterval(() => {
                            if (currentGame !== 'poop') {
                                clearInterval(poopInterval);
                                poopInterval = null;
                                return;
                            }
                            spawnPoop();
                        }, poopSpawnInterval);
                    }
                    
                    // 20ì´ˆ í›„: 1ì´ˆë‹¹ 1ê°œì”© ì¶”ê°€ (ëˆ„ì )
                    if (elapsed >= 20000) {
                        const additionalPoops = Math.floor((elapsed - 20000) / 1000);
                        for (let i = 0; i < additionalPoops + 1; i++) {
                            spawnPoop();
                        }
                        clearInterval(poopInterval);
                        poopInterval = setInterval(() => {
                            if (currentGame !== 'poop') {
                                clearInterval(poopInterval);
                                poopInterval = null;
                                return;
                            }
                            spawnPoop();
                        }, 100); // ë¹ ë¥´ê²Œ ìƒì„±
                    } else {
                        spawnPoop();
                    }
                }, poopSpawnInterval);
            }
        }
        
        function spawnPoop() {
            poops.push({
                x: Math.random() * canvas.width,
                y: 0,
                speed: 3 + Math.random() * 3
            });
        }
        
        function updatePoopGame() {
            // ë˜¥ ì´ë™
            poops = poops.filter(poop => {
                poop.y += poop.speed;
                
                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
                if (poop.y > canvas.height) return false;
                
                // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ ì²´í¬
                Object.keys(users).forEach(userId => {
                    if (eliminatedUsers.has(userId)) return;
                    
                    const user = users[userId];
                    if (!user || user.isTeacher) return;
                    
                    const dist = Math.sqrt(Math.pow(user.x - poop.x, 2) + Math.pow(user.y - poop.y, 2));
                    if (dist < 30) {
                        eliminatedUsers.add(userId);
                        playSound('poopHit');
                        
                        // ìƒì¡´ì ìˆ˜ ì²´í¬ (êµì‚¬ ì œì™¸)
                        const survivors = Object.keys(users).filter(id => {
                            const u = users[id];
                            return !eliminatedUsers.has(id) && u && !u.isTeacher;
                        });
                        
                        if (survivors.length === 1 && !winnerAnnounced) {
                            winnerAnnounced = true;
                            const winner = users[survivors[0]];
                            showGameStatus(`ğŸ‰ ${winner.emoji} ${winner.name} ìš°ìŠ¹!`, 3000);
                            playSound('win');
                            
                            // ìŠ¹ì ì±„íŒ… ê³µì§€
                            database.ref('chat').push({
                                userId: 'system',
                                name: 'ğŸ“¢ ê³µì§€',
                                emoji: 'ğŸ“¢',
                                message: `ğŸ‰ ë˜¥ í”¼í•˜ê¸° ê²Œì„ ìŠ¹ì: ${winner.emoji} ${winner.name}`,
                                timestamp: Date.now()
                            });
                            playSound('announce');
                            
                            // ê²Œì„ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ - êµì‚¬ê°€ ì¤‘ì§€ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ìœ ì§€
                        } else if (survivors.length === 0 && !winnerAnnounced) {
                            winnerAnnounced = true;
                            showGameStatus('ê²Œì„ ì¢…ë£Œ - ìƒì¡´ì ì—†ìŒ', 3000);
                            
                            // ê²Œì„ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ - êµì‚¬ê°€ ì¤‘ì§€ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ìœ ì§€
                        }
                    }
                });
                
                return true;
            });
        }
        
        // ì¢€ë¹„ ê²Œì„
        let zombies = {};
        let zombieWinnerAnnounced = false;
        
        document.getElementById('zombieGameBtn').addEventListener('click', function() {
            if (currentGame === 'zombie') {
                // ê²Œì„ ì¤‘ë‹¨ - ëª¨ë“  ìƒíƒœ ì›ë˜ëŒ€ë¡œ
                database.ref('game').remove();
                this.textContent = 'ğŸ˜± ì¢€ë¹„ ê²Œì„';
                this.classList.remove('active');
                
                // ì¤‘ë‹¨ ê³µì§€
                database.ref('chat').push({
                    userId: 'system',
                    name: 'ğŸ“¢ ê³µì§€',
                    emoji: 'ğŸ“¢',
                    message: 'ğŸ˜± ì¢€ë¹„ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                    timestamp: Date.now()
                });
                playSound('announce');
                
                // ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”
                zombies = {};
                zombieWinnerAnnounced = false;
            } else {
                // ê²Œì„ ì‹œì‘ - í•™ìƒ 3ëª… ì´ìƒ ì²´í¬
                const userIds = Object.keys(users).filter(id => {
                    const u = users[id];
                    return u && !u.isTeacher;
                });
                
                if (userIds.length < 3) {
                    showGameStatus('âš ï¸ í•™ìƒì´ 3ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!', 2000);
                    return;
                }
                
                const randomZombie = userIds[Math.floor(Math.random() * userIds.length)];
                const zombieData = {};
                zombieData[randomZombie] = true;
                zombieWinnerAnnounced = false;
                
                database.ref('game').set({
                    type: 'zombie',
                    zombies: zombieData,
                    startTime: Date.now()
                });
                
                this.textContent = 'ğŸ˜± ê²Œì„ ì¤‘ë‹¨';
                this.classList.add('active');
                showGameStatus('ğŸ˜± ì¢€ë¹„ ê²Œì„ ì‹œì‘!', 2000);
                playSound('zombieStart');
                
                // ê³µì§€
                database.ref('chat').push({
                    userId: 'system',
                    name: 'ğŸ“¢ ê³µì§€',
                    emoji: 'ğŸ“¢',
                    message: 'ğŸ˜± ì¢€ë¹„ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!',
                    timestamp: Date.now()
                });
                playSound('announce');
            }
        });
        
        function startZombieGame(gameData) {
            zombies = gameData.zombies || {};
            zombieWinnerAnnounced = false;
        }
        
        function updateZombieGame() {
            // ì¶©ëŒ ì²´í¬
            Object.keys(users).forEach(userId => {
                if (zombies[userId]) {
                    // ì¢€ë¹„ê°€ ë‹¤ë¥¸ ì‚¬ëŒê³¼ ì¶©ëŒí–ˆëŠ”ì§€ ì²´í¬
                    const zombie = users[userId];
                    if (!zombie) return;
                    
                    Object.keys(users).forEach(targetId => {
                        if (targetId === userId || zombies[targetId]) return;
                        
                        const target = users[targetId];
                        if (!target || target.isTeacher) return;
                        
                        const dist = Math.sqrt(Math.pow(zombie.x - target.x, 2) + Math.pow(zombie.y - target.y, 2));
                        if (dist < 40) {
                            // ê°ì—¼!
                            if (isTeacher) {
                                const newZombies = {...zombies};
                                newZombies[targetId] = true;
                                database.ref('game/zombies').set(newZombies);
                                playSound('zombieInfect');
                                
                                // ìƒì¡´ì ìˆ˜ ì²´í¬ (êµì‚¬ ì œì™¸)
                                const survivors = Object.keys(users).filter(id => {
                                    const u = users[id];
                                    return !newZombies[id] && u && !u.isTeacher;
                                });
                                
                                if (survivors.length === 1 && !zombieWinnerAnnounced) {
                                    zombieWinnerAnnounced = true;
                                    const winner = users[survivors[0]];
                                    showGameStatus(`ğŸ† ${winner.emoji} ${winner.name} ìµœí›„ ìƒì¡´!`, 3000);
                                    playSound('win');
                                    
                                    // ìŠ¹ì ì±„íŒ… ê³µì§€
                                    database.ref('chat').push({
                                        userId: 'system',
                                        name: 'ğŸ“¢ ê³µì§€',
                                        emoji: 'ğŸ“¢',
                                        message: `ğŸ† ì¢€ë¹„ ê²Œì„ ìµœí›„ ìƒì¡´: ${winner.emoji} ${winner.name}`,
                                        timestamp: Date.now()
                                    });
                                    playSound('announce');
                                    
                                    // ê²Œì„ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ - êµì‚¬ê°€ ì¤‘ì§€ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ìœ ì§€
                                } else if (survivors.length === 0 && !zombieWinnerAnnounced) {
                                    zombieWinnerAnnounced = true;
                                    showGameStatus('ê²Œì„ ì¢…ë£Œ - ëª¨ë‘ ì¢€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤', 3000);
                                    
                                    // ê²Œì„ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ - êµì‚¬ê°€ ì¤‘ì§€ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ìœ ì§€
                                }
                            }
                        }
                    });
                }
            });
        }
        
        // ê²Œì„ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showGameStatus(message, duration) {
            const statusDiv = document.getElementById('gameStatus');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, duration);
        }
        
        // ëª¨ë°”ì¼ í„°ì¹˜ ì¡°ì‘ (ì¶”í›„ ì¶”ê°€ ì˜ˆì •)
        // TODO: í„°ì¹˜ ì¡°ì´ìŠ¤í‹± êµ¬í˜„
        
    </script>
</body>
</html>
